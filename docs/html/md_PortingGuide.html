<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>AWS IoT Embedded C Device SDK: PortingGuide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AWS IoT Embedded C Device SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">PortingGuide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>#Porting Guide</p>
<h2>Scope</h2>
<p>The scope of this document is to provide instructions to modify the provided source files and functions in this SDK to run in a variety of embedded Câ€“based environments (e.g. real-time OS, embedded Linux) and to be adjusted to use a specific TLS implementation as available with specific hardware platforms.</p>
<h2>Contents of the SDK</h2>
<p>The SDK ported for linux can be downloaded from the below link:</p><ul>
<li><a href="https://s3.amazonaws.com/aws-iot-device-sdk-embedded-c/linux_mqtt_mbedtls-2.0.0.tar">mbedTLS from ARM</a></li>
</ul>
<p>The C-code files of this SDK are delivered via the following directory structure (see comment behind folder name for an explanation of its content).</p>
<p>Current SDK Directory Layout (mbedTLS)</p>
<p>|&ndash;<code>certs</code> (Private key, device certificate and Root CA) <br />
 |&ndash;<code>docs</code> (Developer guide &amp; API documentation) <br />
 |&ndash;<code>external_libs</code> (external libraries - jsmn, mbedTLS) <br />
 |&ndash;<code>include</code> (Header files of the AWS IoT device SDK) <br />
 |&ndash;<code>src</code> (Source files of the AWS IoT device SDK) <br />
 |&ndash;<code>platform</code> (Platform specific files) <br />
 |&ndash;<code>samples</code> (Samples including makefiles for building on mbedTLS) <br />
 |&ndash;<code>tests</code> (Tests for verifying SDK is functioning as expected) <br />
</p>
<p>All makefiles in this SDK were configured using the documented folder structure above, so moving or renaming folders will require modifications to makefiles.</p>
<h2>Explanation of folders and their content</h2>
<ul>
<li><code>certs</code> : This directory is initially empty and will need to contain the private key, the client certificate and the root CA. The client certificate and private key can be downloaded from the AWS IoT console or be created using the AWS CLI commands. The root CA can be downloaded from <a href="https://www.symantec.com/content/en/us/enterprise/verisign/roots/VeriSign-Class%203-Public-Primary-Certification-Authority-G5.pem">Symantec</a>.</li>
<li><code>docs</code> : SDK API and file documentation.</li>
<li><code>external_libs</code> : The mbedTLS and jsmn source files. The jsmn source files are always present. The mbedTLS source files are only included when downloading the tarball version of the SDK.</li>
<li><code>include</code> : This directory contains the header files that an application using the SDK needs to include.</li>
<li><code>src</code> : This directory contains the SDK source code including the MQTT library, device shadow code and utilities.</li>
<li><code>platform</code> : Platform specific files for timer, TLS and threading layers. Includes a reference implementation for the linux using mbedTLS and pthread.</li>
<li><code>samples</code> : This directory contains sample applications as well as their makefiles. The samples include a simple MQTT example which publishes and subscribes to the AWS IoT service as well as a device shadow example that shows example usage of the device shadow functionality.</li>
<li><code>tests</code> : Contains tests for verifying SDK functionality. For further details please check the readme file included with the tests <a href="https://github.com/aws/aws-iot-device-sdk-embedded-C/blob/master/tests/README.md/">here</a>.</li>
</ul>
<h2>Integrating the SDK into your environment</h2>
<p>This section explains the API calls that need to be implemented in order for the Device SDK to run on your platform. The SDK interfaces follow the driver model where only prototypes are defined by the Device SDK itself while the implementation is delegated to the user of the SDK to adjust it to the platform in use. The following sections list the needed functionality for the device SDK to run successfully on any given platform.</p>
<h3><a class="el" href="structTimer.html">Timer</a> Functions</h3>
<p>A timer implementation is necessary to handle request timeouts (sending MQTT connect, subscribe, etc. commands) as well as connection maintenance (MQTT keep-alive pings). Timers need millisecond resolution and are polled for expiration so these can be implemented using a "milliseconds since startup" free-running counter if desired. In the synchronous sample provided with this SDK only one command will be "in flight" at one point in time plus the client's ping timer.</p>
<p>Define the <code><a class="el" href="structTimer.html">Timer</a></code> Struct as in <code><a class="el" href="timer__platform_8h.html">timer_platform.h</a></code></p>
<p><code>void <a class="el" href="timer_8c.html#abd6b6d6d34f8cf389be1bba056bf0486" title="Initialize a timer. ">init_timer(Timer *)</a>;</code> init_timer - A timer structure is initialized to a clean state.</p>
<p><code>bool <a class="el" href="timer_8c.html#acc0c8cf537941c0ce7bc843fcbd559f4" title="Check if a timer is expired. ">has_timer_expired(Timer *)</a>;</code> has_timer_expired - a polling function to determine if the timer has expired.</p>
<p><code>void <a class="el" href="timer_8c.html#a8140cd322abf1a036683991b1bd45d5a" title="Create a timer (milliseconds) ">countdown_ms(Timer *, uint32_t)</a>;</code> countdown_ms - set the timer to expire in x milliseconds and start the timer.</p>
<p><code>void <a class="el" href="timer_8c.html#a10e629f7bda608a5b6e2182bf991f0e2" title="Create a timer (seconds) ">countdown_sec(Timer *, uint32_t)</a>;</code> countdown_sec - set the timer to expire in x seconds and start the timer.</p>
<p><code>uint32_t <a class="el" href="timer_8c.html#a80b2c30e992293fb070432bcaf0640ca" title="Check the time remaining on a given timer. ">left_ms(Timer *)</a>;</code> left_ms - query time in milliseconds left on the timer.</p>
<h3><a class="el" href="structNetwork.html" title="Network Structure. ">Network</a> Functions</h3>
<p>In order for the MQTT client stack to be able to communicate via the TCP/IP network protocol stack using a mutually authenticated TLS connection, the following API calls need to be implemented for your platform.</p>
<p>For additional details about API parameters refer to the <a href="http://aws-iot-device-sdk-embedded-c-docs.s3-website-us-east-1.amazonaws.com/index.html">API documentation</a>.</p>
<p>Define the <code>TLSDataParams</code> Struct as in <code><a class="el" href="network__platform_8h_source.html">network_platform.h</a></code> This is used for data specific to the TLS library being used.</p>
<p>`IoT_Error_t iot_tls_init(<a class="el" href="structNetwork.html" title="Network Structure. ">Network</a> <em>pNetwork, char *pRootCALocation, char *pDeviceCertLocation, char *pDevicePrivateKeyLocation, char *pDestinationURL, uint16_t DestinationPort, uint32_t timeout_ms, bool ServerVerificationFlag);` Initialize the network client / structure.</em></p>
<p><em><code>IoT_Error_t <a class="el" href="network__interface_8h.html#aa7d2bec765aee3a495b3e9371b300f2e" title="Create a TLS socket and open the connection. ">iot_tls_connect(Network *pNetwork, TLSConnectParams *TLSParams)</a>;</code> Create a TLS TCP socket to the configure address using the credentials provided via the NewNetwork API call. This will include setting up certificate locations / arrays.</em></p>
<p><em>`IoT_Error_t iot_tls_write(<a class="el" href="structNetwork.html" title="Network Structure. ">Network</a></em>, unsigned char*, size_t, <a class="el" href="structTimer.html">Timer</a> *, size_t *);` Write to the TLS network buffer.</p>
<p><code>IoT_Error_t <a class="el" href="network__interface_8h.html#a983bbb02be46c5baf0a29cd5a0a51110" title="Read bytes from the network socket. ">iot_tls_read(Network*, unsigned char*,  size_t, Timer *, size_t *)</a>;</code> Read from the TLS network buffer.</p>
<p><code>IoT_Error_t <a class="el" href="network__interface_8h.html#ac096af28345db79a15765976158bced0" title="Disconnect from network socket. ">iot_tls_disconnect(Network *pNetwork)</a>;</code> Disconnect API</p>
<p><code>IoT_Error_t <a class="el" href="network__interface_8h.html#a3278bd5d18d91d31b426be52a9f62f8f" title="Perform any tear-down or cleanup of TLS layer. ">iot_tls_destroy(Network *pNetwork)</a>;</code> Clean up the connection</p>
<p><code>IoT_Error_t <a class="el" href="network__interface_8h.html#a279735559e72d9bb7c969ca859e7ed17" title="Check if TLS layer is still connected. ">iot_tls_is_connected(Network *pNetwork)</a>;</code> Check if the TLS layer is still connected</p>
<p>The TLS library generally provides the API for the underlying TCP socket.</p>
<h3>Threading Functions</h3>
<p>The MQTT client uses a state machine to control operations in multi-threaded situations. However it requires a mutex implementation to guarantee thread safety. This is not required in situations where thread safety is not important and it is disabled by default. The <em>ENABLE_THREAD_SUPPORT</em> macro needs to be defined in aws_iot_config.h to enable this layer. You will also need to add the -lpthread linker flag for the compiler if you are using the provided reference implementation.</p>
<p>For additional details about API parameters refer to the <a href="http://aws-iot-device-sdk-embedded-c-docs.s3-website-us-east-1.amazonaws.com/index.html">API documentation</a>.</p>
<p>Define the <code>IoT_Mutex_t</code> Struct as in <code><a class="el" href="threads__platform_8h_source.html">threads_platform.h</a></code> This is used for data specific to the TLS library being used.</p>
<p><code>IoT_Error_t aws_iot_thread_mutex_init(IoT_Mutex_t *);</code> Initialize the mutex provided as argument.</p>
<p><code>IoT_Error_t aws_iot_thread_mutex_lock(IoT_Mutex_t *);</code> Lock the mutex provided as argument</p>
<p><code>IoT_Error_t aws_iot_thread_mutex_unlock(IoT_Mutex_t *);</code> Unlock the mutex provided as argument.</p>
<p><code>IoT_Error_t aws_iot_thread_mutex_destroy(IoT_Mutex_t *);</code> Destroy the mutex provided as argument.</p>
<p>The threading layer provides the implementation of mutexes used for thread-safe operations.</p>
<h3>Sample Porting:</h3>
<p>Marvell has ported the SDK for their development boards. <a href="https://github.com/marvell-iot/aws_starter_sdk/tree/master/sdk/external/aws_iot/platform/wmsdk">These</a> files are example implementations of the above mentioned functions. This provides a port of the timer and network layer. The threading layer is not a part of this port.</p>
<h2>Time source for certificate validation</h2>
<p>As part of the TLS handshake the device (client) needs to validate the server certificate which includes validation of the certificate lifetime requiring that the device is aware of the actual time. Devices should be equipped with a real time clock or should be able to obtain the current time via NTP. Bypassing validation of the lifetime of a certificate is not recommended as it exposes the device to a security vulnerability, as it will still accept server certificates even when they have already has_timer_expired.</p>
<h2>Integration into operating system</h2>
<h3>Single-Threaded implementation</h3>
<p>The single threaded implementation implies that the sample application code (SDK + MQTT client) is called periodically by the firmware application running on the main thread. This is done by calling the function <code>aws_iot_mqtt_yield</code> (in the simple pub-sub example) and by calling <code><a class="el" href="aws__iot__shadow__interface_8h.html#a00882fe30c853d0a35997f1b2f80a289" title="Yield function to let the background tasks of MQTT and Shadow. ">aws_iot_shadow_yield()</a></code> (in the device shadow example). In both cases the keep-alive time is set to 10 seconds. This means that the yield functions need to be called at a minimum frequency of once every 10 seconds. Note however that the <code>iot_mqtt_yield()</code> function takes care of reading incoming MQTT messages from the IoT service as well and hence should be called more frequently depending on the timing requirements of an application. All incoming messages can only be processed at the frequency at which <code>yield</code> is called.</p>
<h3>Multi-Threaded implementation</h3>
<p>In the simple multi-threaded case the <code>yield</code> function can be moved to a background thread. Ensure this task runs at the frequency described above. In this case, depending on the OS mechanism, a message queue or mailbox could be used to proxy incoming MQTT messages from the callback to the worker task responsible for responding to or dispatching messages. A similar mechanism could be employed to queue publish messages from threads into a publish queue that are processed by a publishing task. Ensure the threading layer is enabled as the library is not thread safe otherwise. There is a validation test for the multi-threaded implementation that can be found with the integration tests. You can find further details in the Readme for the integration tests https://github.com/aws/aws-iot-device-sdk-embedded-C/blob/master/tests/integration/README.md "here". We have run the validation test with 10 threads sending 500 messages each and verified to be working fine. It can be used as a reference testing application to validate whether your use case will work with multi-threading enabled.</p>
<h2>Sample applications</h2>
<p>The sample apps in this SDK provide a working implementation for mbedTLS. They use a reference implementation for linux provided with the SDK. Threading layer is enabled in the subscribe publish sample. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
